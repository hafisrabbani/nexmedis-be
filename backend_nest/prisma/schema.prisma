generator client {
  provider     = "prisma-client-js"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This table is a partition table and requires additional setup for migrations. Visit https://pris.ly/d/partition-tables for more info.
model api_logs {
  id         BigInt   @default(autoincrement())
  client_id  String   @db.Uuid
  endpoint   String   @db.VarChar(255)
  ip_address String   @db.Inet
  created_at DateTime @default(now()) @db.Timestamp(6)
  clients    clients  @relation(fields: [client_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_api_logs_client")

  @@id([id, created_at])
  @@index([client_id, created_at], map: "idx_api_logs_client_time")
  @@index([created_at], map: "idx_api_logs_time")
}

model client_ip_whitelists {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  client_id  String   @db.Uuid
  ip_address String   @db.Inet
  created_at DateTime @default(now()) @db.Timestamp(6)
  clients    clients  @relation(fields: [client_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_ip_whitelist_client")

  @@unique([client_id, ip_address], map: "uq_client_ip")
}

model clients {
  id                   String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  client_id            String                 @unique @db.VarChar(64)
  name                 String                 @db.VarChar(255)
  email                Bytes
  api_key_hash         String                 @db.VarChar(255)
  status               client_status          @default(active)
  created_at           DateTime               @default(now()) @db.Timestamp(6)
  api_logs             api_logs[]
  client_ip_whitelists client_ip_whitelists[]
  daily_usage          daily_usage[]

  @@index([api_key_hash], map: "idx_clients_api_key_hash")
}

model daily_usage {
  id             BigInt   @id @default(autoincrement())
  client_id      String   @db.Uuid
  date           DateTime @db.Date
  total_requests BigInt   @default(0)
  created_at     DateTime @default(now()) @db.Timestamp(6)
  updated_at     DateTime @default(now()) @db.Timestamp(6)
  clients        clients  @relation(fields: [client_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_daily_usage_client")

  @@unique([client_id, date], map: "uq_daily_usage_client_date")
  @@index([date], map: "idx_daily_usage_date")
}

enum client_status {
  active
  revoked
}
